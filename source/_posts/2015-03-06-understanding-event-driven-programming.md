title: 理解事件驱动编程
date: 2015-03-06
tags: 事件驱动编程
---
> 这篇文章的目的：__通过不断提出问题，解决问题的方式来帮助理解事件驱动编程的产生背景、实现原理、类似机制、具体操作、典型应用等__。

[维基百科解释](http://en.wikipedia.org/wiki/Event-driven_programming)：
> 计算机编程中，事件驱动编程（evnet-driven programming）是种编程范式，其中程序流（flow of program）由事件决定，比如用户交互、其他程序的消息等。

从这个概念中我们至少可以抽出三点东西：
1. 编程范式。说明它能解决某种典型问题的。
2. 程序流由事件决定。说明事件驱动编程改变了程序流的执行方式。
3. 用户交互。说明其典型应用场景。

<!-- more -->

接着，
> 在事件驱动的应用中，通常会有一个事件循环（event loop）来监听事件，如果检测到事件，就触发一个回调函数。在嵌入式系统中，可以通过硬件中断（hardware interrupt）而不是事件循环来达到同样的功能。

这里说明了事件驱动的实现方式/机制：
1. 事件循环
2. 硬件中断

可能还有其他的实现方式，但是这些概念作为起点已经够了。我们抽出下面的关键词：
1. 程序流
2. 事件循环
3. 中断

在深入研究这些关键词，我们先总结一下自己所能想到的疑问：
1. 为什么会出现事件驱动编程？它能解决什么问题？这是背景。
2. 它使如何解决这些问题的？实现方式是什么？这是原理。
3. 除了它还有没有解决相同问题的其他方式？它们之间的对比是怎样的？这是横向对比。
4. 它的典型应用场景是什么？具体如何使用？这是应用。  

我们根据关键词和疑问逐步深入来展开。

## 背景和解决的问题

先看程序流。我们熟悉的控制结构有这么几类：
- 顺序结构
- 条件结构，比如`if`, `switch`
- 循环结构，比如`for`, `while`
- 跳转结构，比如`continue`, `return`, `break`

以上控制结构的执行过程我们应该不陌生，这些都是我们自己代码中的执行流，我们的代码是由进程或者线程来执行的。在代码中，我们可能会进行文件读写、网络请求等IO操作。然后问题来了。

计算机存储体系是个金字塔结构，越往下的设备[读写速度越慢](http://www.blackglory.me/understanding-the-node-js-event-loop/)，内存、缓存和CPU的读写速度相差不是很大，_但是对于磁盘和网络读写时间，会与前面的高速设备相差几个数量级！_不能忍。那进行这些IO操作时，进程/线程怎么办呢，要不要继续下去了？

这里可能会有两个问题：性能问题和资源使用问题。
1. 性能问题。如果是服务器程序，如何来处理大量并发请求。
2. 资源使用问题。读写IO时如果进程/线程等待的话，会造成资源浪费。

传统的处理方式：
1. 阻塞。整个进程/线程将等待IO读取完毕才继续。这将导致整个进程/线程不能做其他事，浪费资源、性能低下。
2. 多进程。新建子进程来处理新的请求。可以做其他事了，但是开销很大。
3. 多线程。新建线程来处理新请求。可以做其他事，开销相对较小，但是多线程编程很麻烦。

所以，事件驱动编程应运而生。那么它解决的核心问题是：__IO相关的性能问题和资源使用问题，并简化编程模型__。回答了疑问1，那么它的实现方式是怎样的？

__更多__：
维基百科：[控制流](http://en.wikipedia.org/wiki/Control_flow)

## 事件循环

本质上，事件循环是一个死循环，不断监测是否有新事件到来，有的话就派发或者处理。Windows的消息循环就是这样一个死循环。然后我们继续思考：
1. 既然是死循环，怎么执行我们的业务代码？
2. 怎么判断是否有新事件到来？是谁来通知？怎么通知？
3. 会不会维护一个未处理的事件队列？这个队列会不会有优先级排序？
4. 事件处理是事件循环线程来处理，还是派发给其他线程完成？
5. 如果是事件循环线程处理，如果有的事件执行事件太长怎么办？

我们知道JS或者AS（规范都是ECMAScript）都是单线程的。但这句话是有误导性的，应该说，我们的代码是单线程的，事件循环是另一个单独的线程。事件在我们的代码中生成，并派发给事件线程；事件线程接到事件，然后通知我们的代码线程。上面一句的上半部分其实是不对的，事件可能在其他进程或者/线程中产生，比如鼠标移动这种IO事件。然后又产生了新的问题：
* 进程间通信（inter-process communication, ipc）和线程间通信，事件通知
* 中断（interrupt），事件生成
* 并发（concurrenct），多线程事件处理


_v0.1 本文需要图示(直观)、代码演示(示例)、参考链接(佐证)、排版标注(强调)，未完成版本，仅提供思路_

